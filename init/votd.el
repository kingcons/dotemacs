(defvar bsb/vinyl-collection
  '((:artist "Amble" :album "Drip" :genre "Electronic" :label "Repeatle")
    (:artist "Amon Tobin" :album "Bricolage" :genre "Electronic" :label "Ninja Tune")
    (:artist "Amon Tobin" :album "Permutation" :genre "Electronic" :label "Ninja Tune")
    (:artist "Amon Tobin" :album "Supermodified" :genre "Electronic" :label "Ninja Tune")
    (:artist "Amon Tobin" :album "Out from Out Where" :genre "Electronic" :label "Ninja Tune")
    (:artist "Andrea" :album "Outlines" :genre "Electronic" :label "Ilian Tape")
    (:artist "Andrea" :album "Ritorno" :genre "Electronic" :label "Ilian Tape")
    (:artist "Andy Stott" :album "Luxury Problems" :genre "Electronic" :label "Modern Love")
    (:artist "Aoki Takamasa" :album "RV8" :genre "Electronic" :label "Raster-Noton")
    (:artist "Aphex Twin" :album "Selected Ambient Works" :genre "Electronic" :label "Warp")
    (:artist "Aurora Halal" :album "Liquiddity" :genre "Electronic" :label "Mutual Dreaming")
    (:artist "Autechre" :album "Tri Repetae" :genre "Electronic" :label "Warp")
    (:artist "Autechre" :album "Chiastic Slide" :genre "Electronic" :label "Warp")
    (:artist "Autechre" :album "LP5" :genre "Electronic" :label "Warp")
    (:artist "Baltra" :album "Ambition" :genre "Electronic" :label "Local Action")
    (:artist "Barker" :album "Debiasing" :genre "Electronic" :label "Ostgut Ton")
    (:artist "Barker" :album "Utility" :genre "Electronic" :label "Ostgut Ton")
    (:artist "Barker" :album "BARKER001" :genre "Electronic" :label "Ostgut Ton")
    (:artist "Barker" :album "BARKER002" :genre "Electronic" :label "Ostgut Ton")
    (:artist "Beatrice Dillon" :album "Workaround" :genre "Electronic" :label "PAN")
    (:artist "Boards of Canada" :album "Geogaddi" :genre "Electronic" :label "Warp")
    (:artist "Burial" :album "Burial" :genre "Electronic" :label "Hyperdub")
    (:artist "Burial" :album "Untrue" :genre "Electronic" :label "Hyperdub")
    (:artist "Burial" :album "Kindred" :genre "Electronic" :label "Hyperdub")
    (:artist "Call Super" :album "Suzi Ecto" :genre "Electronic" :label "Houndstooth")
    (:artist "Clark" :album "Clark" :genre "Electronic" :label "Warp")
    (:artist "Clark" :album "Superscope" :genre "Electronic" :label "Warp")
    (:artist "Com Truise" :album "Galactic Melt" :genre "Electronic" :label "Ghostly")
    (:artist "Daed" :album "Coordinate" :genre "Electronic" :label "Analogical Force")
    (:artist "Daniel Avery" :album "Drone Logic" :genre "Electronic" :label "Phantasy Sound")
    (:artist "Daniel Avery" :album "Song for Alpha" :genre "Electronic" :label "Phantasy Sound")
    (:artist "Daniel Avery" :album "Love + Light" :genre "Electronic" :label "Phantasy Sound")
    (:artist "Daniel Avery" :album "Together in Static" :genre "Electronic" :label "Phantasy Sound")
    (:artist "Daniel Avery + Alessandro Cortini" :album "Illusion of Time" :genre "Electronic" :label "Mute Records")
    (:artist "Datach'i" :album "Bones" :genre "Electronic" :label "Timesig")
    (:artist "Djrum" :album "Broken Glass Arch" :genre "Electronic" :label "R&S Records")
    (:artist "Djrum" :album "Portrait in Firewood" :genre "Electronic" :label "R&S Records")
    (:artist "Djrum" :album "Hard to Say / Tournesol" :genre "Electronic" :label "R&S Records")
    (:artist "Earth Trax" :album "LP1" :genre "Electronic" :label "Shall Not Fade")
    (:artist "Earth Trax" :album "LP2" :genre "Electronic" :label "Shall Not Fade")
    (:artist "Floating Points" :album "J&W Beat" :genre "Electronic" :label "Planet Mu")
    (:artist "Floating Points" :album "Shadows" :genre "Electronic" :label "Eglo Records")
    (:artist "Floating Points" :album "Elaenia" :genre "Electronic" :label "Luaka Bop")
    (:artist "Floating Points" :album "Kuiper" :genre "Electronic" :label "Luaka Bop")
    (:artist "Floating Points" :album "Crush" :genre "Electronic" :label "Ninja Tune")
    (:artist "Forest Drive West" :album "Dualism" :genre "Electronic" :label "Livity Sound")
    (:artist "Four Tet" :album "Rounds" :genre "Electronic" :label "Domino")
    (:artist "Four Tet" :album "There Is Love In You" :genre "Electronic" :label "Domino")
    (:artist "Four Tet" :album "Pink" :genre "Electronic" :label "Text Records")
    (:artist "Function" :album "Existenz" :genre "Electronic" :label "Tresor")
    (:artist "Future Sound of London" :album "Lifeforms" :genre "Electronic" :label "Universal Music")
    (:artist "Galaxian" :album "Coming Up for Air" :genre "Electronic" :label "Ilian Tape")
    (:artist "HVL" :album "Ostati" :genre "Electronic" :label "Organic Analogue")
    (:artist "HVL" :album "Rhythmic Sonatas" :genre "Electronic" :label "Bassiani")
    (:artist "HVL" :album "Alignment" :genre "Electronic" :label "Appian Sounds")
    (:artist "HVL" :album "Aura Fossil" :genre "Electronic" :label "Appian Sounds")
    (:artist "JakoJako" :album "Lux" :genre "Electronic" :label "Leisure System")
    (:artist "Jan Jelinek" :album "Loop-finding-jazz-records" :genre "Electronic" :label "Faitiche")
    (:artist "John Tejada" :album "Signs Under Test" :genre "Eletronic" :label "Kompakt")
    (:artist "Jon Hopkins" :album "Immunity" :genre "Electronic" :label "Domino")
    (:artist "Jon Hopkins" :album "Singularity" :genre "Electronic" :label "Domino")
    (:artist "Juan Atkins & Moritz Von Oswald" :album "Transport" :genre "Electronic" :label "Tresor")
    (:artist "Kangding Ray" :album "Solens Arc" :genre "Electronic" :label "Raster-Noton")
    (:artist "Kangding Ray" :album "Hyper Opal Mantis" :genre "Electronic" :label "Stroboscopic Artefacts")
    (:artist "Karenn" :album "Music Sound Better with Shoe" :genre "Electronic" :label "Voam")
    (:artist "Kessler" :album "Ambivalent" :genre "Electronic" :label "Shall Not Fade")
    (:artist "Leon Vynehall" :album "Music for the Uninvited" :genre "Electronic" :label "3024")
    (:artist "Leon Vynehall" :album "Rojus (Designed to Dance)" :genre "Electronic" :label "Running Back")
    (:artist "Leon Vynehall" :album "Rare, Forever" :genre "Electronic" :label "Ninja Tune")
    (:artist "Linkwood" :album "Mono" :genre "Electronic" :label "Athens of the North")
    (:artist "Lone" :album "Levitate" :genre "Electronic" :label "R&S Records")
    (:artist "Machinedrum" :album "Vapor City" :genre "Electronic" :label "Ninja Tune")
    (:artist "Machinedrum" :album "A View of U" :genre "Electronic" :label "Ninja Tune")
    (:artist "Minor Science" :album "Second Language" :genre "Electronic" :label "Whities")
    (:artist "Moderat" :album "II" :genre "Electronic" :label "Monkeytown Records")
    (:artist "MPU 101" :album "MPU 101" :genre "Electronic" :label "Ilian Tape")
    (:artist "Neon Chambers" :album "One" :genre "Electronic" :label "Dekmantel")
    (:artist "Objekt" :album "Objekt #2" :genre "Electronic" :label "Objekt")
    (:artist "Objekt" :album "Flatland" :genre "Electronic" :label "PAN")
    (:artist "Objekt" :album "Hypnagogia" :genre "Electronic" :label "Leisure System")
    (:artist "Overmono" :album "BMW Track / So U Kno" :genre "Electronic" :label "Poly Kicks")
    (:artist "Patricia" :album "Blue Ridge" :genre "Electronic" :label "Analogical Force")
    (:artist "Porter Ricks" :album "Biokinetics" :genre "Electronic" :label "Mille Plateaux")
    (:artist "Prodigy" :album "The Fat of the Land" :genre "Electronic" :label "XL Recordings")
    (:artist "Reece Cox" :album "Emotion 1" :genre "Electronic" :label "Kulor")
    (:artist "Roel Funcken" :album "Sapper Morton" :genre "Electronic" :label "Analogical Force")
    (:artist "RTR" :album "Symmetriades" :genre "Electronic" :label "Analogical Force")
    (:artist "Ryan James Ford" :album "Six Stair" :genre "Electronic" :label "Savy Records")
    (:artist "Shaun Rudiman" :album "Conduit" :genre "Electronic" :label "Pittsburgh Tracks")
    (:artist "Shaun Rudiman" :album "Flow State" :genre "Electronic" :label "Pittsburgh Tracks")
    (:artist "Shed" :album "Shedding the Past" :genre "Electronic" :label "Ostgut Ton")
    (:artist "Shed" :album "The Traveller" :genre "Electronic" :label "Ostgut Ton")
    (:artist "Shinra" :album "Meteor" :genre "Electronic" :label "Analogical Force")
    (:artist "Shinra" :album "Supernova" :genre "Electronic" :label "Analogical Force")
    (:artist "Shinra" :album "Vital Heat" :genre "Electronic" :label "Analogical Force")
    (:artist "Shinra" :album "Darkroom" :genre "Electronic" :label "Craigie Knowes")
    (:artist "Skee Mask" :album "Compro" :genre "Electronic" :label "Ilian Tape")
    (:artist "Skee Mask" :album "ISS006" :genre "Electronic" :label "Ilian Tape")
    (:artist "Skee Mask" :album "Pool" :genre "Electronic" :label "Ilian Tape")
    (:artist "Skee Mask" :album "ISS007" :genre "Electronic" :label "Ilian Tape")
    (:artist "Sky H1" :album "Azure" :genre "Electronic" :label "AD 93")
    (:artist "Special Request" :album "Soul Music" :genre "Electronic" :label "Houndstooth")
    (:artist "Stenny" :album "Stress Test" :genre "Electronic" :label "Ilian Tape")
    (:artist "Stenny" :album "Upsurge" :genre "Electronic" :label "Ilian Tape")
    (:artist "Squarepusher" :album "Feed Me Weird Things" :genre "Electronic" :label "Warp")
    (:artist "Thom Yorke + Four Tet + Burial" :album "Ego / Mirror" :genre "Electronic" :label "Text Records")
    (:artist "Thom Yorke + Four Tet + Burial" :album "Her Revolution / His Rope" :genre "Electronic" :label "Text Records")
    (:artist "Tim Hecker" :album "Harmony in Ultraviolet" :genre "Electronic" :label "Kranky")
    (:artist "Tobias" :album "1972" :genre "Electronic" :label "Ostgut Ton")
    (:artist "Topdown Dialectic" :album "Vol 1" :genre "Electronic" :label "Peak Oil")
    (:artist "Topdown Dialectic" :album "Vol 2" :genre "Electronic" :label "Peak Oil")
    (:artist "Tycho" :album "Dive" :genre "Electronic" :label "Ghostly")
    (:artist "Various Artists" :album "Tresor 30" :genre "Electronic" :label "Tresor")
    (:artist "Venetian Snares" :album "Rossz Csillag Alatt Szuletett" :genre "Electronic" :label "Planet Mu")
    (:artist "Wata Igarashi & Voiski" :album "9719" :genre "Electronic" :label "Delsin")
    (:artist "Wata Igarashi" :album "New Dawn" :genre "Electronic" :label "Figure 8")
    (:artist "Xyla" :album "Ways" :genre "Electronic" :label "Leaving Records")
    ;; Indie
    (:artist "Air" :album "Moon Safari" :genre "Indie")
    (:artist "Band of Horses" :album "Everything All the Time" :genre "Indie")
    (:artist "Beach Bunny" :album "Prom Queen" :genre "Indie")
    (:artist "Broken Social Scene" :album "You Forgot it in People" :genre "Indie")
    (:artist "Built to Spill" :album "Keep it like a Secret" :genre "Indie")
    (:artist "Car Seat Headrest" :album "Teens of Denial" :genre "Indie")
    (:artist "case/lang/veirs" :album "case/lang/veirs" :genre "Indie")
    (:artist "Death Cab for Cutie" :album "Transatlanticism" :genre "Indie")
    (:artist "DIIV" :album "Is the is are" :genre "Indie")
    (:artist "DIIV" :album "Deceiver" :genre "Indie")
    (:artist "Explosions in the Sky" :album "The Earth is not a cold, dead place" :genre "Indie")
    (:artist "Fleet Foxes" :album "Fleet Foxes" :genre "Indie")
    (:artist "Fleet Foxes" :album "Shore" :genre "Indie")
    (:artist "Florist" :album "Emily Alone" :genre "Indie")
    (:artist "Gorillaz" :album "Demon Dayz" :genre "Indie")
    (:artist "Interpol" :album "Turn on the Bright Lights" :genre "Indie")
    (:artist "Iron & Wine" :album "Woman King" :genre "Indie")
    (:artist "Jay Som" :album "Everybody Works" :genre "Indie")
    (:artist "Jay Som" :album "Anak Ko" :genre "Indie")
    (:artist "Japanese Breakfast" :album "Soft Sounds from Another Planet" :genre "Indie")
    (:artist "Japanese Breakfast" :album "Jubilee" :genre "Indie")
    (:artist "Jimmy Eat World" :album "Bleed American" :genre "Indie")
    (:artist "Julien Baker" :album "Sprained Ankle" :genre "Indie")
    (:artist "Laura Veirs" :album "Saltbreakers" :genre "Indie")
    (:artist "Laura Veirs" :album "July Flame" :genre "Indie")
    (:artist "Lucy Dacus" :album "Home Video" :genre "Indie")
    (:artist "Massive Attack" :album "Protection" :genre "Indie")
    (:artist "Massive Attack vs Mad Professor" :album "No Protection" :genre "Indie")
    (:artist "Massive Attack" :album "Mezzanine" :genre "Indie")
    (:artist "Modest Mouse" :album "Good News for People Who Love Bad News" :genre "Indie")
    (:artist "Moses Sumney" :album "Aromanticism" :genre "Indie")
    (:artist "Moses Sumney" :album "Grae" :genre "Indie")
    (:artist "My Bloody Valentine" :album "Loveless" :genre "Indie")
    (:artist "My Bloody Valentine" :album "mbv" :genre "Indie")
    (:artist "Phoebe Bridgers" :album "Punisher" :genre "Indie")
    (:artist "Pinback" :album "Summer in Abaddon" :genre "Indie")
    (:artist "Pinback" :album "Autumn of the Seraphs" :genre "Indie")
    (:artist "Purity Ring" :album "Shrines" :genre "Indie")
    (:artist "Radiohead" :album "OK Computer" :genre "Indie")
    (:artist "Radiohead" :album "Kid A Mnesia" :genre "Indie")
    (:artist "Radiohead" :album "In Rainbows" :genre "Indie")
    (:artist "Real Estate" :album "Days" :genre "Indie")
    (:artist "Snail Mail" :album "Valentine" :genre "Indie")
    (:artist "Soccer Mommy" :album "Clean" :genre "Indie")
    (:artist "Spoon" :album "Girls Can Tell" :genre "Indie")
    (:artist "The Long Winters" :album "Ultimatum" :genre "Indie")
    (:artist "The National" :album "Boxer" :genre "Indie")
    (:artist "The National" :album "High Violet" :genre "Indie")
    (:artist "The Sea & Cake" :album "Oui" :genre "Indie")
    (:artist "The Sea & Cake" :album "One Bedroom" :genre "Indie")
    (:artist "The Sea & Cake" :album "Everybody" :genre "Indie")
    (:artist "The Sea & Cake" :album "Car Alarm" :genre "Indie")
    (:artist "The Sea & Cake" :album "Runner" :genre "Indie")
    (:artist "The Shins" :album "Oh, Inverted World" :genre "Indie")
    (:artist "Tortoise" :album "TNT" :genre "Indie")
    (:artist "Wet Leg" :album "Wet Leg" :genre "Indie")
    (:artist "Disasterpeace" :album "Rise of the Obsidian Interstellar" :genre "Soundtrack")
    (:artist "Paul Haslinger" :album "Halt and Catch Fire" :genre "Soundtrack")
    (:artist "Paul Haslinger" :album "Halt and Catch Fire Volume 2" :genre "Soundtrack")
    (:artist "Christopher Larkin" :album "Hollow Knight" :genre "Soundtrack")
    (:artist "Lena Raine" :album "Celeste" :genre "Soundtrack")
    (:artist "Floating Points" :album "Late Night Tales" :genre "Mixtape")
    (:artist "Fennesz" :album "Endless Summer" :genre "Experimental")
    (:artist "Max Richter" :album "The Blue Notebooks" :genre "Experimental")
    (:artist "Nils Frahm" :album "Spaces" :genre "Experimental")
    (:artist "Oneohtrix Point Never" :album "Returnal" :genre "Experimental")
    (:artist "Bill Evans" :album "The Tokyo Concert" :genre "Jazz")
    (:artist "Bill Evans Trio" :album "Waltz for Debby" :genre "Jazz")
    (:artist "Dave Brubeck Quartet" :album "Time Out" :genre "Jazz")
    (:artist "Fergus McCreadie" :album "Cairn" :genre "Jazz")
    (:artist "Floating Points + Pharaoh Sanders" :album "Promises" :genre "Jazz")
    (:artist "Herbie Hancock" :album "Maiden Voyage" :genre "Jazz")
    (:artist "John Coltrane" :album "Blue Train" :genre "Jazz")
    (:artist "John Coltrane" :album "Live at the Village Vanguard" :genre "Jazz")
    (:artist "Kamasi Washington" :album "Harmony of Difference" :genre "Jazz")
    (:artist "Lee Morgan" :album "The Sidewinder" :genre "Jazz")
    (:artist "Miles Davis" :album "Kind of Blue" :genre "Jazz")
    (:artist "Nala Sinephro" :album "Space 1.8" :genre "Jazz")
    (:artist "Resavoir" :album "Resavoir" :genre "Jazz")
    (:artist "Sam Wilkes" :album "WILKES" :genre "Jazz")
    (:artist "Sam Wilkes + Sam Gendel" :album "Music for Saxophone and Bass Guitar" :genre "Jazz")
    (:artist "Sarah Vaughan + Clifford Brown" :album "Sarah Vaughan + Clifford Brown" :genre "Jazz")
    (:artist "Sonny Rollins" :album "The Bridge" :genre "Jazz")
    (:artist "Sonny Rollins Quartet" :album "Tenor Madness" :genre "Jazz")
    (:artist "The Comet is Coming" :album "Prophecy" :genre "Jazz")
    (:artist "The Comet is Coming" :album "Channel the Spirits" :genre "Jazz")
    (:artist "The Comet is Coming" :album "Death to the Planet" :genre "Jazz")
    (:artist "Marvin Gaye" :album "What's Going On" :genre "Soul")
    (:artist "Bibio" :album "Ambivalence Avenue" :genre "Futurebeats")
    (:artist "Flying Lotus" :album "Cosmogramma" :genre "Futurebeats")
    (:artist "Flying Lotus" :album "Until the Quiet Comes" :genre "Futurebeats")
    (:artist "J Dilla" :album "Donuts" :genre "Futurebeats")
    (:artist "Teebs" :album "Ardour" :genre "Futurebeats")
    (:artist "The Avalanches" :album "Since I Left You" :genre "Futurebeats")))

(defun bsb/discogs-search (artist album)
  (let* ((token (password-store-get "discogs/kingcons"))
         (auth-header (format "Discogs token=%s" token))
         (url-request-extra-headers `(("Authorization" . ,auth-header)))
         (base-url "https://api.discogs.com/")
         (base-params "?type=release&format=vinyl")
         (params (format "%s&artist=%s&release_title=%s" base-params artist album))
         (request-url (format "%s/database/search?%s" base-url params)))
    (with-current-buffer
        (url-retrieve-synchronously request-url)
      (goto-char (point-min))
      (let ((data (when (re-search-forward "\r?\n\r?\n" nil t)
                    (json-read))))
        (kill-buffer (current-buffer))
        data))))

(defun bsb/show-cover-art (response)
  (cl-labels ((cover-art (x) (cdr (assoc 'cover_image x)))
              (blank-art? (x) (string-match-p "spacer.gif" (cover-art x))))
    (let* ((results (cdr (assoc 'results response)))
           (record (car (seq-remove #'blank-art? results))))
      (if (null record)
          (message "No matching album found!")
        (let ((cover-art-url (cover-art record)))
          (browse-web cover-art-url)
          (message (format "Now Playing: %s" (cdr (assoc 'title record)))))))))

(defun bsb/filter-vinyl (attribute value)
  (let ((results (seq-copy bsb/vinyl-collection)))
    (cl-flet ((match? (plist) (string= (plist-get plist attribute) value)))
      (seq-filter #'match? results))))

(defun bsb/choose-record (attribute value)
  (let ((candidates (bsb/filter-vinyl attribute value)))
    (bsb/show-random-album candidates)))

(defun bsb/show-random-album (candidates)
  (let* ((record (seq-random-elt candidates))
         (artist (plist-get record :artist))
         (album (plist-get record :album))
         (response (bsb/discogs-search artist album)))
    (bsb/show-cover-art response)))

(defun bsb/gimme-techno ()
  (interactive)
  (bsb/choose-record :genre "Electronic"))

(defun bsb/gimme-music ()
  (interactive)
  (bsb/show-random-album bsb/vinyl-collection))

(global-set-key (kbd "s-n") 'bsb/gimme-techno)
(global-set-key (kbd "s-m") 'bsb/gimme-music)
